# Layer 3 & 4: 设计层 + 实践层 — 详细定义

> 本文件是 [INDEX.md](./INDEX.md) 的展开。AI 按需读取，不在 startup 时加载。

---

## Layer 3: 设计层

### DESIGN-01: Open-Closed Principle (OCP) — 开闭原则

**含义**: 对扩展开放，对修改封闭。加新功能时，应该**添加**代码，而不是**改**已有代码。

**所属族**: SOLID 五原则之一

**应用场景**: 处理多种输入类型（路由模式 vs if-else）、插件系统、配置驱动

**出现记录**: [2026-02-10-pm 规则3](./projects/001-textbook/2026-02-10-pm.md)

---

### DESIGN-02: Data Integrity Principle — 数据链路完整性

**含义**: 功能设计必须建立在**可获取的、真实的数据**之上。如果数据不存在，功能不应该假装它存在。

**与 YAGNI 的关系**: YAGNI 关注需求，数据链路完整性关注可行性。

**出现记录**: [2026-02-10-pm 规则2](../projects/001-textbook/2026-02-10-pm.md)

---

### DESIGN-03: Bacterial Code — 细菌式代码

**含义**: 代码应该像细菌而非器官 — 自包含、无状态、可独立存活、容易从仓库中被"提取"出来复用。

**来源**: Andrej Karpathy，2026-02。他用 AI 从 torchao 库提取 fp8 训练功能，150 行自包含代码替掉整个库依赖，反而快了 3%。

**设计建议**: 少全局状态、功能自包含、接口简洁、依赖越少越好。

**与已有原则**: `ARCH-01` 分离的极端形式 + `ARCH-04` 可移植性 + `PRACTICE-02` 依赖重量。

**批判性注意**: AI 提取的代码可能"能用但不完全理解"，对初学者是隐性技术债。

**出现记录**: [2026-02-12-pm-1 规则23](../projects/001-textbook/2026-02-12-pm-1.md)

---

### DESIGN-04: Orthogonal Decomposition — 正交分解

**含义**: 当需要大量个性化变体时，不穷举所有组合，而是拆成互不干扰的独立维度，用排列组合生成变体。

**来源**: 宝玉 (baoyu-skills), 2026-02。他把封面图风格拆成 6 个维度（构图/色彩/渲染/文字/情绪/字体），32 个选项组合出 15,552 种风格。

**数学本质**: 维度独立 → 乘法关系。6×9×6×4×3×4 = 15,552。

**三层渐进设计**（降低使用门槛）:

| 层 | 面向谁 | 做法 |
|----|--------|------|
| Layer 1: 自动推荐 | 小白 | 根据内容自动在每个维度选值 |
| Layer 2: Presets | 进阶用户 | 一个关键词设定多个维度 |
| Layer 3: 偏好文件 | 高级用户 | 持久化存储默认值 |

**适用场景**: 任何需要个性化定制的 AI 应用 — prompt 模板、代码风格、文档格式。

**与已有原则**: `ARCH-01` 每个维度是独立关注点 + `DESIGN-01` OCP 每层扩展不改下层。

**出现记录**: [2026-02-12-pm-1](../projects/001-textbook/2026-02-12-pm-1.md)

---

### SOLID 族谱（参考）

| 缩写 | 原则 | 一句话 | 已遇到？ |
|------|------|--------|----------|
| **S** | Single Responsibility | 一个模块只做一件事 | 是（≈关注点分离的代码版） |
| **O** | Open-Closed | 加功能靠扩展不靠改代码 | ✅ 2026-02-10 |
| **L** | Liskov Substitution | 子类能替代父类使用 | 尚未 |
| **I** | Interface Segregation | 接口小而专，不要大而全 | 尚未 |
| **D** | Dependency Inversion | 依赖抽象，不依赖具体实现 | 尚未 |

---

## Layer 4: 实践层

### PRACTICE-01: Technical Debt Prioritization — 技术债优先级

**含义**: 影响日常效率的系统性问题，优先级高于新功能开发。

**判断公式**: `影响次数 × 每次浪费时间 = 总成本`。总成本 > 修复成本 → 立刻修。

**出现记录**: [2026-02-10-pm 规则5](./projects/001-textbook/2026-02-10-pm.md)

---

### PRACTICE-02: Dependency Weight Awareness — 依赖重量意识

**含义**: 安装任何依赖前检查兼容性、体积、和替代方案。重型依赖是隐形的资源炸弹。

**检查清单**: (1) 兼容性? (2) 体积/内存? (3) 更轻的替代?

**出现记录**: [2026-02-11-late 规则8](./projects/001-textbook/2026-02-11-late.md)

---

### PRACTICE-03: Traceability — 可追溯性

**含义**: 任何决策都应该能回答"为什么"。记录证据、推理、结论三联，并标注证据强度。

**格式**: `[推理] 证据 → 推理 → 结论 [依据: 已验证/有依据/推测]`

**价值**: 决策者知道为什么选这个方案；执行者知道多可靠；未来审计时可理解当时逻辑。

**出现记录**: [2026-02-11-late-2 规则9](./projects/001-textbook/2026-02-11-late-2.md)

---

### PRACTICE-04: Quality Gate — 质量门禁

**含义**: 自动生成的产出物必须经过**可量化的检查**才算完成。

**四层防线框架**:

| 层级 | 问的问题 | 手段 | 确定性 |
|------|----------|------|--------|
| Layer 1: 缩小射程 | 任务拆小了吗？ | distributed_execution | ✅ |
| Layer 2: 结构化约束 | 输出格式对吗？ | Schema/模板/规则 | ✅ |
| Layer 3: 事后验证 | 结果对吗？ | 编译器/测试/lint | ✅ |
| Layer 4: 人类兜底 | 人确认了吗？ | 审查/批准 | ✅ |

**关键**: Layer 3 必须用确定性工具，不能用另一个 AI。

**出现记录**: 2026-02-11 Vibe-Poo 分析, [2026-02-11-late-4 规则19](./projects/001-textbook/2026-02-11-late-4.md)

---

### PRACTICE-05: Quantifiable Quality Thresholds — 可量化的质量阈值

**含义**: 质量门禁的阈值必须是**具体数字**。没有数字的质量检查等于没有检查。

**与 Quality Gate 的关系**: `PRACTICE-04` 定义了"要检查"，`PRACTICE-05` 定义了"多少算合格"。

**举例**:

| 领域 | 阈值 | 依据 |
|------|------|------|
| 代码 | 文件 ≤800 行, 函数 ≤200 行 | 工业经验 |
| 教学文档 | 6-12 页/单元, 知识点 100% 覆盖 | V3.5 规范 |
| Typst 编译 | 0 错误, 0 警告 | 最低标准 |

**出现记录**: 2026-02-11 Vibe-Poo 分析

---

### PRACTICE-07: Deterministic-First Automation — 确定性优先

**含义**: 每件事用最确定的方式做。优先级：脚本 > 工具/命令 > MCP > Sub-agent > 多 Agent。

**判断标准**: 步骤固定、输入输出明确 → 脚本。需要"看"和"判断" → Agent。

**自动化时机**: AI 探路（第一次做），搞清楚后写脚本（第二次起）。

**已写入 `role-SECA.md`**: Section 7 DETERMINISTIC-FIRST AUTOMATION。

**出现记录**: [2026-02-11-late-4 规则21](./projects/001-textbook/2026-02-11-late-4.md)
